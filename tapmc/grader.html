<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Grader | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>Grader 分級台</h1>
        <div class="small">審查 AI 建議、修正品質欄位並完成分級。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="graderId">Grader ID（完成必填）</label>
          <input id="graderId" type="text" placeholder="bob">
        </div>
        <div style="flex:1;">
          <label for="statusFilter">佇列狀態</label>
          <select id="statusFilter">
            <option value="ai_suggested">ai_suggested</option>
            <option value="tallied">tallied</option>
            <option value="">全部</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>佇列</h3>
        <div id="queueList" class="table-scroll"></div>
      </div>
      <div class="card">
        <div class="flex between">
          <h3>批次細節</h3>
          <div class="chip" id="statusChip"></div>
        </div>
        <div id="aiBlock" class="card subtle" style="margin-bottom:12px;"></div>
        <div id="graderForm"></div>
        <div class="input-row" style="margin-top:10px;">
          <button class="btn secondary" id="saveDraft">儲存草稿</button>
          <button class="btn" id="finalizeBtn">Finalize 完成分級</button>
        </div>
        <div class="divider"></div>
        <div>
          <h4>Log</h4>
          <div id="logList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const graderIdInput = document.getElementById('graderId');
    const queueList = document.getElementById('queueList');
    const statusChip = document.getElementById('statusChip');
    const aiBlock = document.getElementById('aiBlock');
    const graderForm = document.getElementById('graderForm');
    const logList = document.getElementById('logList');
    let current = null;
    let activeImageData = '';

    function requireGraderId() {
      const id = graderIdInput.value.trim();
      if (!id) {
        alert('完成分級需填 Grader ID。');
        return null;
      }
      return id;
    }

    function renderQueue() {
      const status = document.getElementById('statusFilter').value;
      const rows = MockDB.getRows(status ? { status } : {});
      if (!rows.length) {
        queueList.innerHTML = '<div class="small">佇列為空。</div>';
        return;
      }
      const html = `
        <table>
          <thead><tr><th>批次</th><th>品項</th><th>狀態</th><th>AI</th><th></th></tr></thead>
          <tbody>
            ${rows.map((r) => `
              <tr>
                <td>${r.batch_id}</td>
                <td>${r.item || '(未填描述)'}</td>
                <td>${tapmcUtils.statusBadge(r.status)}</td>
                <td>${r.ai_suggestions ? '有' : '無'}</td>
                <td><button class="btn secondary" data-open="${r.row_id}">開啟</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      queueList.innerHTML = html;
      queueList.querySelectorAll('[data-open]').forEach((btn) => btn.addEventListener('click', () => openRow(btn.dataset.open)));
    }

    function openRow(rowId) {
      current = MockDB.getRows().find((r) => r.row_id === rowId);
      activeImageData = current?.image_data || '';
      renderDetail();
      renderLogs();
    }

    function renderDetail() {
      if (!current) {
        statusChip.textContent = '尚未選擇';
        aiBlock.innerHTML = '';
        graderForm.innerHTML = '<div class="small">請選擇批次。</div>';
        return;
      }
      statusChip.innerHTML = tapmcUtils.statusBadge(current.status);
      aiBlock.innerHTML = current.ai_suggestions ? `
        <div class="flex between">
          <div>
            <div class="small">模型</div>
            <strong>${current.ai_suggestions.model}</strong>
          </div>
          <div class="small">產生時間 ${current.ai_suggestions.ai_generated_at || ''}</div>
        </div>
        <div class="grid" style="margin-top:8px;">
          ${Object.entries(current.ai_suggestions.predictions || {}).map(([k, v]) => `<div class="chip">${k}: ${v} (c=${current.ai_suggestions.confidences?.[k] ?? '-'})</div>`).join('')}
        </div>
      ` : '<div class="small">尚無 AI 建議。</div>';

      const schema = PRODUCT_SCHEMAS[current.product_id];
      const quality = { ...current.ai_suggestions?.predictions, ...current.quality_data };
      graderForm.innerHTML = `
        <div class="grid">
          <div><label>批次</label><input type="text" value="${current.batch_id}" disabled></div>
          <div><label>品項</label><input type="text" value="${current.product_id} · ${schema?.name || ''}" disabled></div>
          <div><label>來源</label><input id="g-source" type="text" value="${current.source || ''}"></div>
          <div><label>供應人</label><input id="g-producer" type="text" value="${current.producer || ''}"></div>
          <div><label>箱數</label><input id="g-boxes" type="number" min="1" value="${current.boxes || 0}"></div>
          <div><label>重量/數量</label><input id="g-qty" type="number" min="1" value="${current.quantity || 0}"></div>
          <div><label>起標價</label><input id="g-start" type="number" min="0" value="${current.start_price || ''}"></div>
          <div><label>最終等級</label>
            <select id="g-grade">
              <option value="">請選擇</option>
              <option value="A" ${current.final_grade === 'A' ? 'selected' : ''}>A</option>
              <option value="B" ${current.final_grade === 'B' ? 'selected' : ''}>B</option>
              <option value="C" ${current.final_grade === 'C' ? 'selected' : ''}>C</option>
            </select>
          </div>
        </div>
        <div style="grid-column:1/-1; margin-top:8px;">
          <label>照片上傳</label>
          <input id="g-image" type="file" accept="image/*">
          <img id="g-preview" alt="預覽" style="margin-top:8px; max-width:100%; border-radius:10px; display:${current.image_data ? 'block' : 'none'};" src="${current.image_data || ''}">
        </div>
        <div class="divider"></div>
        <h4>品質欄位</h4>
        <div class="grid">
          ${schema ? Object.entries(schema.fields).map(([key, meta]) => {
            const val = quality?.[key];
            if (meta.type === 'enum') {
              return `<div><label>${meta.label}</label><select data-q="${key}">${meta.options.map((o) => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>`;
            }
            if (meta.type === 'boolean') {
              return `<div><label>${meta.label}</label><select data-q="${key}"><option value="false" ${val === false ? 'selected' : ''}>否</option><option value="true" ${val === true ? 'selected' : ''}>是</option></select></div>`;
            }
            return `<div><label>${meta.label}</label><input type="number" data-q="${key}" min="${meta.min}" max="${meta.max}" step="${meta.step || 1}" value="${val ?? ''}"></div>`;
          }).join('') : '<div class="small">無對應 schema。</div>'}
        </div>
      `;
    }

    function collectDiff(updated) {
      const diff = {};
      Object.keys(updated).forEach((k) => {
        if (JSON.stringify(updated[k]) !== JSON.stringify(current[k])) {
          diff[k] = { from: current[k], to: updated[k] };
        }
      });
      return diff;
    }

    function buildPatch() {
      if (!current) return null;
      const quality = {};
      graderForm.querySelectorAll('[data-q]').forEach((el) => {
        const key = el.dataset.q;
        if (el.tagName === 'SELECT') {
          const val = el.value;
          quality[key] = val === 'true' ? true : val === 'false' ? false : val;
        } else {
          quality[key] = el.value === '' ? null : Number(el.value);
        }
      });
      return {
        source: document.getElementById('g-source').value,
        producer: document.getElementById('g-producer').value,
        boxes: Number(document.getElementById('g-boxes').value),
        quantity: Number(document.getElementById('g-qty').value),
        start_price: document.getElementById('g-start').value === '' ? null : Number(document.getElementById('g-start').value),
        final_grade: document.getElementById('g-grade').value,
        quality_data: quality,
        image_data: activeImageData
      };
    }

    function save(statusOverride) {
      const graderId = requireGraderId();
      if (!graderId || !current) return;
      const patch = buildPatch();
      if (!patch) return;
      if (statusOverride === 'graded') {
        if (!patch.final_grade || patch.start_price == null) {
          alert('完成分級需填最終等級與起標價。');
          return;
        }
      }
      const updated = MockDB.updateRow(current.row_id, { ...patch, status: statusOverride || current.status, updated_by: `GRD:${graderId}` });
      const diff = collectDiff(updated);
      MockDB.appendLog({ role: 'GRD', actor_id: graderId, action: statusOverride === 'graded' ? 'grade_finalize' : 'grade_save', row_id: current.row_id, diff, ts: updated.updated_at });
      current = updated;
      tapmcUtils.toast(statusOverride === 'graded' ? '已完成分級' : '草稿已儲存');
      renderQueue();
      renderDetail();
      renderLogs();
    }

    function renderLogs() {
      if (!current) {
        logList.innerHTML = '<div class="small">尚未選擇。</div>';
        return;
      }
      const logs = MockDB.getLogs({ row_id: current.row_id });
      if (!logs.length) {
        logList.innerHTML = '<div class="small">尚無 log。</div>';
        return;
      }
      logList.innerHTML = logs.slice(-5).map((l) => `<div class="chip">${l.ts} · ${l.role}:${l.actor_id} · ${l.action}</div>`).join('');
    }

    document.getElementById('statusFilter').addEventListener('change', renderQueue);
    document.getElementById('saveDraft').addEventListener('click', () => save(current?.status || 'ai_suggested'));
    document.getElementById('finalizeBtn').addEventListener('click', () => save('graded'));
    document.addEventListener('change', (e) => {
      if (e.target.id === 'g-image') {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          activeImageData = ev.target.result;
          const img = document.getElementById('g-preview');
          img.src = activeImageData;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    graderIdInput.value = MockDB.getDefaultId() || '';
    renderQueue();
    renderDetail();
  </script>
</body>
</html>
