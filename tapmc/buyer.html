<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Buyer | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>Buyer 瀏覽</h1>
        <div class="small">瀏覽已分級/拍賣批次，查看詳情、加入追蹤或詢價。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="buyerId">Buyer ID</label>
          <input id="buyerId" type="text" placeholder="buyer01">
        </div>
        <div style="flex:1;">
          <label for="filterProduct">品項</label>
          <select id="filterProduct"></select>
        </div>
        <div style="flex:1;">
          <label for="filterGrade">最終等級</label>
          <select id="filterGrade">
            <option value="">全部</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
          </select>
        </div>
        <div style="flex:1;">
          <label for="filterSearch">關鍵字</label>
          <input id="filterSearch" type="text" placeholder="描述 / 來源 / 批次">
        </div>
      </div>
    </div>

    <div id="cardList" class="grid" style="margin-top:16px;"></div>

    <div class="modal" id="detailModal">
      <div class="panel">
        <div class="flex between">
          <h3 id="modalTitle">批次詳情</h3>
          <button class="btn secondary" id="closeModal">關閉</button>
        </div>
        <div id="modalBody"></div>
        <div class="input-row" style="margin-top:12px;">
          <button class="btn secondary" id="watchBtn">加入追蹤</button>
          <button class="btn" id="inquiryBtn">詢價</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const buyerIdInput = document.getElementById('buyerId');
    const cardList = document.getElementById('cardList');
    const modal = document.getElementById('detailModal');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    let selected = null;

    function fillProductOptions() {
      const sel = document.getElementById('filterProduct');
      sel.innerHTML = '<option value="">全部</option>' + Object.entries(PRODUCT_SCHEMAS).map(([id, meta]) => `<option value="${id}">${id} · ${meta.name}</option>`).join('');
    }

    function filteredRows() {
      const product = document.getElementById('filterProduct').value;
      const grade = document.getElementById('filterGrade').value;
      const text = document.getElementById('filterSearch').value.trim().toLowerCase();
      return MockDB.getRows().filter((r) => ['graded', 'sold', 'returned', 'ai_suggested', 'auctioned'].includes(r.status)).filter((r) => {
        if (product && String(r.product_id) !== product) return false;
        if (grade && r.final_grade !== grade) return false;
        if (text) {
          const hay = `${r.item} ${r.source} ${r.producer} ${r.batch_id}`.toLowerCase();
          if (!hay.includes(text)) return false;
        }
        return true;
      });
    }

    function renderCards() {
      const rows = filteredRows();
      if (!rows.length) {
        cardList.innerHTML = '<div class="card subtle">沒有符合條件的批次。</div>';
        return;
      }
      cardList.innerHTML = rows.map((r) => `
        <div class="card">
          <div class="flex between">
            <h3>${r.item || '(未填描述)'}</h3>
            ${tapmcUtils.statusBadge(r.status)}
          </div>
          <p>${r.source} · ${r.producer}</p>
          <div class="chip-row" style="margin:6px 0;">
            <span class="chip">等級：${r.final_grade || '—'}</span>
            <span class="chip">起標價：${r.start_price || '—'} ${r.currency || ''}</span>
            <span class="chip">箱數：${r.boxes}</span>
          </div>
          <button class="btn secondary" data-open="${r.row_id}">查看詳情</button>
        </div>
      `).join('');
      cardList.querySelectorAll('[data-open]').forEach((btn) => btn.addEventListener('click', () => openModal(btn.dataset.open)));
    }

    function openModal(rowId) {
      selected = MockDB.getRows().find((r) => r.row_id === rowId);
      if (!selected) return;
      modal.classList.add('active');
      modalTitle.textContent = `${selected.item || selected.batch_id}`;
      modalBody.innerHTML = `
        <div class="grid">
          <div><label>批次</label><div class="chip">${selected.batch_id}</div></div>
          <div><label>等級</label><div class="chip">${selected.final_grade || '—'}</div></div>
          <div><label>起標價</label><div class="chip">${selected.start_price || '—'} ${selected.currency || ''}</div></div>
          <div><label>箱數</label><div class="chip">${selected.boxes}</div></div>
        </div>
        <div class="divider"></div>
        <div><label>歷程</label><div class="small">${selected.updated_at || ''}</div></div>
      `;
    }

    function requireBuyerId() {
      const id = buyerIdInput.value.trim();
      if (!id) {
        alert('建議填 Buyer ID 以記錄 log。');
        return null;
      }
      return id;
    }

    function logAction(action) {
      const id = requireBuyerId();
      if (!id || !selected) return;
      MockDB.appendLog({ role: 'BUY', actor_id: id, action, row_id: selected.row_id, ts: tapmcUtils.toOffsetIso() });
      tapmcUtils.toast(`已紀錄 ${action}`);
    }

    document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));
    document.getElementById('watchBtn').addEventListener('click', () => logAction('watch'));
    document.getElementById('inquiryBtn').addEventListener('click', () => logAction('inquiry'));
    document.getElementById('filterProduct').addEventListener('change', renderCards);
    document.getElementById('filterGrade').addEventListener('change', renderCards);
    document.getElementById('filterSearch').addEventListener('input', renderCards);

    buyerIdInput.value = MockDB.getDefaultId() || '';
    fillProductOptions();
    renderCards();
  </script>
</body>
</html>
