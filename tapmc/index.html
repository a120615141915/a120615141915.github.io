<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>TAPMC Demo | 首頁</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <h1>TAPMC Demo 控制台</h1>
      <div class="pill">
        <span class="tag ok">MVP</span>
        <span class="small">本地示範 · 模擬資料</span>
      </div>
    </div>

    <div class="hero">
      <div class="grid">
        <div>
          <h2>預設使用者 ID</h2>
          <p>儲存預設 ID，其他頁面會自動帶入。</p>
          <div class="input-row">
            <div style="flex:1;">
              <label for="defaultId">預設 ID</label>
              <input id="defaultId" type="text" placeholder="dev01">
            </div>
            <button class="btn" id="saveDefault">儲存</button>
          </div>
          <div class="chip-row" style="margin-top:10px;">
            <span class="chip">目前：<span id="defaultIdStored">-</span></span>
            <span class="chip">Seed 時間：<span id="seededAt">-</span></span>
            <span class="chip">資料筆數：<span id="rowCount">0</span></span>
            <span class="chip">Log 數量：<span id="logCount">0</span></span>
          </div>
        </div>
        <div>
          <h2>資料工具</h2>
          <p>Seed / Reset / 匯出 MockDB。</p>
          <div class="input-row">
            <button class="btn secondary" id="seedBtn">從 data.csv Seed</button>
            <button class="btn secondary" id="resetBtn">重置 Demo</button>
            <button class="btn" id="exportBtn">下載 data.csv</button>
          </div>
          <div class="small" style="margin-top:8px;">每次操作會寫入 log 並帶入目前的預設 ID。</div>
        </div>
      </div>
    </div>

    <h2>角色入口</h2>
    <div class="grid">
      <div class="card">
        <h3>Driver（司機）</h3>
        <p>建立車次、依來源送批。</p>
        <div class="input-row">
          <a class="btn" href="driver.html">開啟 driver.html</a>
          <span class="badge">DRV</span>
        </div>
      </div>
      <div class="card">
        <h3>Tally（點收）</h3>
        <p>檢查批次、填寫品質、觸發 AI 建議。</p>
        <div class="input-row">
          <a class="btn" href="tally.html">開啟 tally.html</a>
          <span class="badge">TLY</span>
        </div>
      </div>
      <div class="card">
        <h3>Grader（分級）</h3>
        <p>審查 AI 建議、設定最終等級與起標價。</p>
        <div class="input-row">
          <a class="btn" href="grader.html">開啟 grader.html</a>
          <span class="badge">GRD</span>
        </div>
      </div>
      <div class="card">
        <h3>Auction（拍賣）</h3>
        <p>全螢幕輪播，快速標記售出/退貨。</p>
        <div class="input-row">
          <a class="btn" href="auction.html">開啟 auction.html</a>
          <span class="badge">AUC</span>
        </div>
      </div>
      <div class="card">
        <h3>Buyer（買家）</h3>
        <p>瀏覽已分級/拍賣批次，查看細節、追蹤或詢價。</p>
        <div class="input-row">
          <a class="btn" href="buyer.html">開啟 buyer.html</a>
          <span class="badge">BUY</span>
        </div>
      </div>
      <div class="card">
        <h3>Dashboard（總覽）</h3>
        <p>KPI 快照與匯出。</p>
        <div class="input-row">
          <a class="btn" href="dashboard.html">開啟 dashboard.html</a>
          <span class="badge">GM</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const defaultIdInput = document.getElementById('defaultId');
    const saveDefaultBtn = document.getElementById('saveDefault');
    const defaultIdStored = document.getElementById('defaultIdStored');
    const seededAtSpan = document.getElementById('seededAt');
    const rowCount = document.getElementById('rowCount');
    const logCount = document.getElementById('logCount');

    function refreshMeta() {
      defaultIdStored.textContent = MockDB.getDefaultId() || '—';
      seededAtSpan.textContent = localStorage.getItem('tapmc_seeded_at') || '—';
      rowCount.textContent = MockDB.getRows().length;
      logCount.textContent = MockDB.getLogs().length;
    }

    saveDefaultBtn.addEventListener('click', () => {
      const id = defaultIdInput.value.trim();
      MockDB.setDefaultId(id);
      tapmcUtils.toast('已儲存預設 ID');
      refreshMeta();
    });

    document.getElementById('seedBtn').addEventListener('click', async () => {
      const res = await fetch('data.csv');
      const txt = await res.text();
      MockDB.initFromCSV(txt);
      MockDB.appendLog({ role: 'GM', actor_id: MockDB.getDefaultId() || 'dev', action: 'seed' });
      tapmcUtils.toast('已從 data.csv seed');
      refreshMeta();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('重置本地 MockDB？')) return;
      MockDB.reset();
      MockDB.appendLog({ role: 'GM', actor_id: MockDB.getDefaultId() || 'dev', action: 'reset' });
      tapmcUtils.toast('MockDB 已重置');
      refreshMeta();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      MockDB.exportCsv();
      MockDB.appendLog({ role: 'GM', actor_id: MockDB.getDefaultId() || 'dev', action: 'export' });
      tapmcUtils.toast('已匯出 data.csv');
      refreshMeta();
    });

    defaultIdInput.value = MockDB.getDefaultId();
    refreshMeta();
  </script>
</body>
</html>
