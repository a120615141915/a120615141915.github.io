<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç†è²¨å»ºæª”</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c1829;
      --panel: rgba(255,255,255,0.07);
      --accent: #f4a261;
      --accent-2: #2a9d8f;
      --text: #f8fbff;
      --muted: #b5c5d8;
      --error: #ff7b7b;
      --success: #3ae6b5;
      --radius: 14px;
      --shadow: 0 16px 40px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: radial-gradient(circle at 70% 20%, rgba(42,157,143,0.18), transparent 32%), radial-gradient(circle at 20% 60%, rgba(244,162,97,0.14), transparent 30%), var(--bg);
      min-height: 100vh;
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 26px;
    }
    .wrap {
      width: min(1100px, 100%);
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border-radius: 18px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      display: grid;
      gap: 18px;
      grid-template-columns: 1.1fr 1fr;
    }
    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 28px; }
    .hint {
      background: rgba(42,157,143,0.14);
      border: 1px dashed rgba(42,157,143,0.5);
      padding: 10px 12px;
      border-radius: 10px;
      color: var(--muted);
    }
    .panel {
      background: var(--panel);
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.08);
    }
    label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
    input, button, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-size: 15px;
    }
    input:focus, textarea:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    .btn {
      background: var(--accent);
      color: #2b1606;
      font-weight: 700;
      cursor: pointer;
      border: none;
      box-shadow: 0 10px 22px rgba(244,162,97,0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .btn:active { transform: translateY(1px); }
    .capture {
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: var(--radius);
      padding: 14px;
      min-height: 280px;
      display: grid;
      gap: 12px;
      align-content: start;
      background: rgba(255,255,255,0.04);
    }
    .thumbs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
    .thumb {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0f2235;
    }
    .thumb img { width: 100%; height: 90px; object-fit: cover; display: block; }
    .status {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: var(--success);
      color: #0c2017;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }
    .error { color: var(--error); font-size: 12px; min-height: 16px; }
    .badge {
      display: inline-block;
      padding: 6px 10px;
      background: rgba(58,230,181,0.16);
      border: 1px solid rgba(58,230,181,0.4);
      color: var(--success);
      border-radius: 8px;
      font-weight: 600;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .table th, .table td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
      font-size: 14px;
    }
    .table th { color: var(--muted); font-weight: 600; }
    .row-link { cursor: pointer; }
    .row-link:hover { background: rgba(255,255,255,0.04); }
    .search {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      margin-bottom: 8px;
    }
    .selected {
      display: inline-block;
      padding: 6px 10px;
      background: rgba(42,157,143,0.2);
      border-radius: 10px;
      border: 1px solid rgba(42,157,143,0.5);
      color: var(--text);
      font-weight: 700;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ç†è²¨å“¡ï½œå»ºæª”</h1>
      <div class="badge">å½±åƒå„ªå…ˆ Â· å¯ç·¨è¼¯æ¨æ–·</div>
    </header>

    <div class="panel" style="grid-column:1 / -1">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:700;">è²¨å“ç¸½è¡¨</div>
        <div class="muted">é»æ“Šä¸€ç­†å³å¯å¸¶å…¥ä¸‹æ–¹è¡¨å–®</div>
      </div>
      <input class="search" id="search" placeholder="æœå°‹æ‰¹æ¬¡ / å“é … / ä¾†æº">
      <table class="table" id="table">
        <thead>
          <tr><th>æ‰¹æ¬¡</th><th>å“é …</th><th>å“ç´š</th><th>ç®±æ•¸</th><th>ä¾†æº</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="selected" class="selected" style="display:none;"></div>
    </div>

    <div class="panel capture">
      <div class="hint">æ‹ç…§å‰æç¤ºï¼šä¿æŒå…‰ç·šå‡å‹»ã€é¡é ­æ°´å¹³ï¼Œå¯é€£æ‹å¤šå¼µã€‚</div>
      <button class="btn" id="captureBtn" type="button">ğŸ“¸ æ‹ç…§ / é¸æ“‡æª”æ¡ˆ</button>
      <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div class="panel">
      <form id="tallyForm" novalidate>
        <div class="field">
          <label for="item">è‡ªå‹•æ¨æ–·å“é …ï¼ˆå¯ä¿®æ”¹ï¼‰</label>
          <input id="item" type="text" value="é«˜éº—èœ (201) (AI æ¨æ–·)" required>
          <div class="error" data-error-for="item"></div>
        </div>
        <div class="field">
          <label for="boxes">ç®±æ•¸ *</label>
          <input id="boxes" type="number" min="1" placeholder="è¼¸å…¥ç®±æ•¸" required>
          <div class="error" data-error-for="boxes"></div>
        </div>
        <button class="btn" type="submit">é€å‡ºå»ºæª”</button>
      </form>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none;position:fixed;top:18px;right:18px;background:var(--success);color:#0c1c16;padding:12px 16px;border-radius:10px;font-weight:700;box-shadow:0 14px 30px rgba(0,0,0,0.35);">å·²é€å‡º</div>

  <script src="storage.js"></script>
  <script>
    const captureBtn = document.getElementById('captureBtn');
    const fileInput = document.getElementById('fileInput');
    const thumbs = document.getElementById('thumbs');
    const toast = document.getElementById('toast');
    const form = document.getElementById('tallyForm');
    const tableBody = document.querySelector('#table tbody');
    const search = document.getElementById('search');
    const selected = document.getElementById('selected');
    let selectedBatch = '';

    captureBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
      thumbs.innerHTML = '';
      Array.from(fileInput.files).slice(0, 6).forEach(file => {
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'thumb';
        div.innerHTML = '<img src="' + url + '" alt="preview"><div class="status">å·²ä¸Šå‚³</div>';
        thumbs.appendChild(div);
      });
      if (fileInput.files.length) {
        document.getElementById('item').value = 'è˜‹æœ (101) (AI æ¨æ–·æ›´æ–°)';
      }
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 1800);
    }
    function setError(id, message) {
      const el = document.querySelector('[data-error-for="' + id + '"]');
      const input = document.getElementById(id);
      el.textContent = message || '';
      input.style.borderColor = message ? 'var(--error)' : 'rgba(255,255,255,0.12)';
    }
    ['item','boxes'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        if (id === 'boxes' && Number(el.value) <= 0) { setError(id, 'éœ€å¤§æ–¼ 0'); return; }
        if (!el.value.trim()) { setError(id, 'å¿…å¡«'); return; }
        setError(id, '');
      });
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const ok = ['item','boxes'].every(id => {
        const input = document.getElementById(id);
        if (!input.value.trim()) { setError(id, 'å¿…å¡«'); return false; }
        if (id === 'boxes' && Number(input.value) <= 0) { setError(id, 'éœ€å¤§æ–¼ 0'); return false; }
        setError(id, ''); return true;
      });
      if (!ok) return;
      showToast('å»ºæª”æˆåŠŸï¼Œå·²åŒæ­¥');
      if (window.MockDB) {
        MockDB.appendCsvRow({
          batch_id: selectedBatch || ('TALLY-' + Date.now()),
          product_id: '',
          item: document.getElementById('item').value,
          final_grade: '',
          boxes: document.getElementById('boxes').value,
          price: '',
          source: 'tally',
          quality_data: { note: 'å½±åƒå»ºæª”' },
          note: 'ç†è²¨è£œç™»'
        });
      }
      form.reset();
      document.getElementById('item').value = 'é«˜éº—èœ (201) (AI æ¨æ–·)';
      thumbs.innerHTML = '';
      renderTable(search.value);
    });

    function renderTable(filter = '') {
      if (!window.MockDB) return;
      const rows = MockDB.getRows().filter(r => {
        return [r.batch_id, r.item, r.source].some(v => (v || '').toLowerCase().includes(filter.toLowerCase()));
      });
      tableBody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'row-link';
        tr.innerHTML = `<td>${r.batch_id}</td><td>${r.item}</td><td>${r.final_grade}</td><td>${r.boxes}</td><td>${r.source}</td>`;
        tr.addEventListener('click', () => {
          document.getElementById('item').value = r.item;
          document.getElementById('boxes').value = r.boxes;
          selectedBatch = r.batch_id;
          selected.style.display = 'inline-block';
          selected.textContent = 'å·²é¸æ‰¹æ¬¡ï¼š' + r.batch_id;
          showToast('å·²å¸¶å…¥æ‰¹æ¬¡ ' + r.batch_id);
        });
        tableBody.appendChild(tr);
      });
    }

    search.addEventListener('input', () => renderTable(search.value));
    renderTable();
  </script>
</body>
</html>
