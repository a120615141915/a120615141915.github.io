<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Tally | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>Tally 點收台</h1>
        <div class="small">檢查批次、填寫品質、送出並觸發 AI 建議。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="tallyId">Tally ID（送出必填）</label>
          <input id="tallyId" type="text" placeholder="amy">
        </div>
        <div style="flex:2;" class="input-row">
          <div style="flex:1;">
            <label for="filterStatus">狀態</label>
            <select id="filterStatus">
              <option value="">全部</option>
              <option value="created">created</option>
              <option value="tallied">tallied</option>
              <option value="ai_suggested">ai_suggested</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="tripFilter">Trip</label>
            <select id="tripFilter"></select>
          </div>
          <div style="flex:1;">
            <label for="filterText">搜尋</label>
            <input id="filterText" type="text" placeholder="來源 / 品項">
          </div>
        </div>
        <button class="btn" id="newBatchBtn">新增批次</button>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>批次清單</h3>
        <div id="batchList" class="table-scroll"></div>
      </div>
      <div class="card">
        <div class="flex between">
          <h3>批次細節</h3>
          <div class="chip" id="aiMeta"></div>
        </div>
        <div class="grid" id="detailForm"></div>
        <div id="qualityFields"></div>
        <div class="input-row" style="margin-top:12px;">
          <button class="btn secondary" id="saveDraftBtn">儲存草稿</button>
          <button class="btn" id="submitAiBtn">送出並觸發 AI</button>
          <button class="btn secondary" id="needsInfoBtn">標記待補資訊</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tallyIdInput = document.getElementById('tallyId');
    const batchList = document.getElementById('batchList');
    const detailForm = document.getElementById('detailForm');
    const qualityFields = document.getElementById('qualityFields');
    const aiMeta = document.getElementById('aiMeta');
    const tripFilter = document.getElementById('tripFilter');
    let activeRow = null;
    let activeImageData = '';

    function requireTallyId() {
      const id = tallyIdInput.value.trim();
      if (!id) {
        alert('送出需要填 Tally ID。');
        return null;
      }
      return id;
    }

    function loadTripOptions() {
      const trips = MockDB.getTrips();
      tripFilter.innerHTML = '<option value="">全部</option>' + trips.map((t) => `<option value="${t.trip_id}">${t.trip_id}</option>`).join('');
      const tripSelect = document.getElementById('d-trip');
      if (tripSelect) {
        tripSelect.innerHTML = '<option value="">請選擇</option>' + trips.map((t) => `<option value="${t.trip_id}">${t.trip_id}</option>`).join('');
      }
    }

    function filterRows() {
      const status = document.getElementById('filterStatus').value;
      const trip = tripFilter.value;
      const text = document.getElementById('filterText').value.trim();
      return MockDB.getRows({ status: status || undefined, trip_id: trip || undefined, text: text || undefined });
    }

    function renderList() {
      loadTripOptions();
      const rows = filterRows();
      if (!rows.length) {
        batchList.innerHTML = '<div class="small">沒有批次，請建立或調整篩選。</div>';
        return;
      }
      const html = `
        <table>
          <thead><tr><th>批次</th><th>品項</th><th>來源</th><th>狀態</th><th>更新時間</th><th></th></tr></thead>
          <tbody>
            ${rows.map((r) => `
              <tr>
                <td>${r.batch_id}</td>
                <td>${r.item || ''}</td>
                <td>${r.source}${r.producer ? '-' + r.producer : ''}</td>
                <td>${tapmcUtils.statusBadge(r.status)}</td>
                <td class="small">${r.updated_at || ''}</td>
                <td><button class="btn secondary" data-open="${r.row_id}">開啟</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      batchList.innerHTML = html;
      batchList.querySelectorAll('[data-open]').forEach((btn) => btn.addEventListener('click', () => openRow(btn.dataset.open)));
    }

    function buildDetailLayout() {
      detailForm.innerHTML = `
        <div>
          <label>批次編號</label>
          <input id="d-batch" type="text" disabled>
        </div>
        <div>
          <label>Trip</label>
          <select id="d-trip"></select>
        </div>
        <div>
          <label>品項</label>
          <select id="d-product">
            <option value="">請選擇</option>
            ${Object.entries(PRODUCT_SCHEMAS).map(([id, meta]) => `<option value="${id}">${id} · ${meta.name}</option>`).join('')}
          </select>
        </div>
        <div>
          <label>來源</label>
          <input id="d-source" type="text">
        </div>
        <div>
          <label>供應人</label>
          <input id="d-producer" type="text">
        </div>
        <div>
          <label>描述 (品項名稱)</label>
          <input id="d-item" type="text">
        </div>
        <div>
          <label>箱數</label>
          <input id="d-boxes" type="number" min="1">
        </div>
        <div>
          <label>重量/數量</label>
          <input id="d-qty" type="number" min="1">
        </div>
        <div>
          <label>單價</label>
          <input id="d-price" type="number" min="0">
        </div>
        <div style="grid-column:1/-1;">
          <label>備註</label>
          <textarea id="d-note"></textarea>
        </div>
        <div style="grid-column:1/-1;">
          <label>照片上傳</label>
          <input id="d-image" type="file" accept="image/*">
          <img id="imagePreview" alt="預覽" style="margin-top:8px; max-width:100%; border-radius:10px; display:none;" />
        </div>
      `;
      document.getElementById('d-product').addEventListener('change', () => renderQualityFields(document.getElementById('d-product').value));
      loadTripOptions();
    }

    function openRow(rowId) {
      const row = MockDB.getRows().find((r) => r.row_id === rowId);
      activeRow = row;
      populateDetail(row);
    }

    function populateDetail(row) {
      if (!row) {
        activeRow = null;
        const dTrip = document.getElementById('d-trip');
        if (dTrip) dTrip.value = tripFilter.value || '';
        document.getElementById('d-batch').value = '新建';
        document.getElementById('d-product').value = '';
        document.getElementById('d-source').value = '';
        document.getElementById('d-producer').value = '';
        document.getElementById('d-item').value = '';
        document.getElementById('d-boxes').value = 1;
        document.getElementById('d-qty').value = 1;
        document.getElementById('d-price').value = 0;
      document.getElementById('d-note').value = '';
      qualityFields.innerHTML = '';
      aiMeta.textContent = '';
      activeImageData = '';
      document.getElementById('imagePreview').src = '';
      document.getElementById('imagePreview').style.display = 'none';
      return;
    }
      document.getElementById('d-batch').value = row.batch_id;
      const dTrip = document.getElementById('d-trip');
      if (dTrip) dTrip.value = row.trip_id;
      document.getElementById('d-product').value = row.product_id;
      document.getElementById('d-source').value = row.source;
      document.getElementById('d-producer').value = row.producer;
      document.getElementById('d-item').value = row.item;
      document.getElementById('d-boxes').value = row.boxes;
      document.getElementById('d-qty').value = row.quantity;
      document.getElementById('d-price').value = row.price;
      document.getElementById('d-note').value = row.note || '';
      activeImageData = row.image_data || '';
      const img = document.getElementById('imagePreview');
      if (activeImageData) {
        img.src = activeImageData;
        img.style.display = 'block';
      } else {
        img.src = '';
        img.style.display = 'none';
      }
      renderQualityFields(row.product_id, row.quality_data || {});
      if (row.ai_suggestions) {
        aiMeta.textContent = `AI：${row.ai_suggestions.model} @ ${row.ai_suggestions.ai_generated_at || ''}`;
      } else {
        aiMeta.textContent = 'AI：尚未產生';
      }
    }

    function renderQualityFields(productId, data = {}) {
      const schema = PRODUCT_SCHEMAS[productId];
      if (!schema) {
        qualityFields.innerHTML = '<div class="small">選擇品項後顯示品質欄位。</div>';
        return;
      }
      qualityFields.innerHTML = `
        <div class="divider"></div>
        <h4>品質資料</h4>
        <div class="grid">
          ${Object.entries(schema.fields).map(([key, meta]) => {
            if (meta.type === 'enum') {
              return `
                <div>
                  <label>${meta.label}</label>
                  <select data-q="${key}">
                    ${meta.options.map((o) => `<option value="${o}" ${data[key] === o ? 'selected' : ''}>${o}</option>`).join('')}
                  </select>
                </div>
              `;
            }
            if (meta.type === 'boolean') {
              return `
                <div>
                  <label>${meta.label}</label>
                  <select data-q="${key}">
                    <option value="false" ${data[key] === false ? 'selected' : ''}>否</option>
                    <option value="true" ${data[key] === true ? 'selected' : ''}>是</option>
                  </select>
                </div>
              `;
            }
            return `
              <div>
                <label>${meta.label}</label>
                <input type="number" data-q="${key}" min="${meta.min}" max="${meta.max}" step="${meta.step || 1}" value="${data[key] ?? ''}">
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function collectForm() {
      const product = document.getElementById('d-product').value;
      const item = document.getElementById('d-item').value.trim();
      const source = document.getElementById('d-source').value.trim();
      const producer = document.getElementById('d-producer').value.trim();
      const boxes = Number(document.getElementById('d-boxes').value);
      const tripSelected = document.getElementById('d-trip').value.trim();
      if (!tripSelected) {
        alert('請選擇 Trip。');
        return null;
      }
      if (!product || !source || !producer || boxes <= 0) {
        alert('品項、來源、供應人、箱數為必填。');
        return null;
      }
      const quality = {};
      qualityFields.querySelectorAll('[data-q]').forEach((el) => {
        const key = el.dataset.q;
        if (el.tagName === 'SELECT') {
          const val = el.value;
          if (val === 'true' || val === 'false') quality[key] = val === 'true';
          else quality[key] = val;
        } else {
          const v = el.value;
          quality[key] = v === '' ? null : Number(v);
        }
      });
      return {
        trip_id: tripSelected,
        product_id: product,
        source,
        producer,
        item: item || PRODUCT_SCHEMAS[product]?.name || '',
        boxes,
        quantity: Number(document.getElementById('d-qty').value),
        price: Number(document.getElementById('d-price').value),
        note: document.getElementById('d-note').value,
        quality_data: quality,
        image_data: activeImageData
      };
    }

    function saveDraft(statusOverride = 'tallied') {
      const tallyId = tallyIdInput.value.trim() || MockDB.getDefaultId();
      const payload = collectForm();
      if (!payload) return;
      if (!activeRow) {
        const row = MockDB.appendCsvRow({
          ...payload,
          batch_id: tapmcUtils.genBatchId('TLY'),
          currency: 'TWD',
          ai_suggestions: null,
          final_grade: '',
          start_price: '',
          status: statusOverride,
          created_by: `TLY:${tallyId || 'unknown'}`,
          updated_by: `TLY:${tallyId || 'unknown'}`
        });
        activeRow = row;
        MockDB.appendLog({ role: 'TLY', actor_id: tallyId || 'unknown', action: 'create_batch', row_id: row.row_id, ts: row.created_at });
      } else {
        const updated = MockDB.updateRow(activeRow.row_id, { ...payload, status: statusOverride, updated_by: `TLY:${tallyId || 'unknown'}` });
        MockDB.appendLog({ role: 'TLY', actor_id: tallyId || 'unknown', action: 'update_batch', row_id: activeRow.row_id, ts: updated.updated_at });
        activeRow = updated;
      }
      tapmcUtils.toast('草稿已儲存');
      renderList();
      populateDetail(activeRow);
    }

    function submitAi() {
      const tallyId = requireTallyId();
      if (!tallyId) return;
      saveDraft('tallied');
      const row = activeRow;
      if (!row) return;
      const ai = MockAI.predict(row.product_id, row.quality_data, tallyId);
      const updated = MockDB.updateRow(row.row_id, { ai_suggestions: ai, updated_by: `TLY:${tallyId}`, status: 'ai_suggested' });
      MockDB.appendLog({ role: 'TLY', actor_id: tallyId, action: 'submit_and_trigger_ai', row_id: row.row_id, ts: updated.updated_at });
      MockDB.appendLog({ role: 'TLY', actor_id: tallyId, action: 'ai_writeback', row_id: row.row_id, ts: ai.ai_generated_at });
      activeRow = updated;
      tapmcUtils.toast('AI 建議已回寫');
      populateDetail(updated);
      renderList();
    }

    document.getElementById('newBatchBtn').addEventListener('click', () => {
      activeRow = null;
      populateDetail(null);
    });
    document.getElementById('saveDraftBtn').addEventListener('click', () => saveDraft('tallied'));
    document.getElementById('submitAiBtn').addEventListener('click', submitAi);
    document.getElementById('needsInfoBtn').addEventListener('click', () => saveDraft('needs_info'));
    document.getElementById('filterStatus').addEventListener('change', renderList);
    tripFilter.addEventListener('change', renderList);
    document.getElementById('filterText').addEventListener('input', renderList);
    document.getElementById('d-image').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        activeImageData = ev.target.result;
        const img = document.getElementById('imagePreview');
        img.src = activeImageData;
        img.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    tallyIdInput.value = MockDB.getDefaultId() || '';
    buildDetailLayout();
    populateDetail(null);
    renderList();
  </script>
</body>
</html>
