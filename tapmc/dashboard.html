<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>GM Dashboard</h1>
        <div class="small">使用 MockDB 計算 KPI 與匯出。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="gmId">GM ID（匯出必填）</label>
          <input id="gmId" type="text" placeholder="gm01">
        </div>
        <div class="input-row">
          <button class="btn secondary" id="refreshBtn">重新計算</button>
          <button class="btn" id="exportBtn">匯出 CSV</button>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>KPI</h3>
        <div id="kpiRow" class="grid"></div>
      </div>
      <div class="card">
        <h3>狀態分佈</h3>
        <div id="statusBars"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>近期批次</h3>
      <div id="recentTable" class="table-scroll"></div>
    </div>
  </div>

  <script>
    const gmIdInput = document.getElementById('gmId');
    const kpiRow = document.getElementById('kpiRow');
    const statusBars = document.getElementById('statusBars');
    const recentTable = document.getElementById('recentTable');

    function renderKpi() {
      const rows = MockDB.getRows();
      const total = rows.length;
      const graded = rows.filter((r) => r.status === 'graded').length;
      const sold = rows.filter((r) => r.status === 'sold').length;
      const returned = rows.filter((r) => r.status === 'returned').length;
      const avgPrice = (() => {
        const prices = rows.filter((r) => r.start_price).map((r) => Number(r.start_price));
        return prices.length ? (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(1) : 'N/A';
      })();
      kpiRow.innerHTML = `
        <div class="card subtle"><div class="small">總筆數</div><h2>${total}</h2></div>
        <div class="card subtle"><div class="small">已分級</div><h2>${graded}</h2></div>
        <div class="card subtle"><div class="small">已售出</div><h2>${sold}</h2></div>
        <div class="card subtle"><div class="small">退貨率</div><h2>${total ? Math.round((returned / total) * 100) : 0}%</h2></div>
        <div class="card subtle"><div class="small">平均起標價</div><h2>${avgPrice}</h2></div>
      `;
    }

    function renderStatusBars() {
      const rows = MockDB.getRows();
      const statuses = {};
      rows.forEach((r) => { statuses[r.status] = (statuses[r.status] || 0) + 1; });
      const entries = Object.entries(statuses);
      if (!entries.length) {
        statusBars.innerHTML = '<div class="small">無資料。</div>';
        return;
      }
      const max = Math.max(...entries.map(([, v]) => v));
      statusBars.innerHTML = entries.map(([status, count]) => `
        <div style="margin-bottom:8px;">
          <div class="flex between">
            <div>${status}</div>
            <div class="small">${count}</div>
          </div>
          <div class="progress"><div class="bar" style="width:${(count / max) * 100}%"></div></div>
        </div>
      `).join('');
    }

    function renderRecent() {
      const rows = MockDB.getRows().sort((a, b) => Date.parse(b.updated_at || 0) - Date.parse(a.updated_at || 0)).slice(0, 8);
      if (!rows.length) {
        recentTable.innerHTML = '<div class="small">尚無批次。</div>';
        return;
      }
      recentTable.innerHTML = `
        <table>
          <thead><tr><th>批次</th><th>品項</th><th>狀態</th><th>等級</th><th>起標價</th><th>更新時間</th></tr></thead>
          <tbody>
            ${rows.map((r) => `
              <tr>
                <td>${r.batch_id}</td>
                <td>${r.item}</td>
                <td>${tapmcUtils.statusBadge(r.status)}</td>
                <td>${r.final_grade || '—'}</td>
                <td>${r.start_price || '—'}</td>
                <td class="small">${r.updated_at || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function refresh() {
      renderKpi();
      renderStatusBars();
      renderRecent();
    }

    document.getElementById('refreshBtn').addEventListener('click', refresh);
    document.getElementById('exportBtn').addEventListener('click', () => {
      const id = gmIdInput.value.trim();
      if (!id) {
        alert('匯出需要填 GM ID。');
        return;
      }
      MockDB.exportCsv();
      MockDB.appendLog({ role: 'GM', actor_id: id, action: 'export', ts: tapmcUtils.toOffsetIso() });
      tapmcUtils.toast('已匯出 CSV');
    });

    gmIdInput.value = MockDB.getDefaultId() || '';
    refresh();
  </script>
</body>
</html>
