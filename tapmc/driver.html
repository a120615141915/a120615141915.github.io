<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Driver | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>Driver 工作台</h1>
        <div class="small">建立車次後，輸入來源與品項並儲存到該車次。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="driverId">Driver ID（必填）</label>
          <input id="driverId" type="text" placeholder="driver01">
        </div>
        <div style="flex:1;">
          <label for="tripSelector">車次 Trip</label>
          <select id="tripSelector"></select>
        </div>
        <button class="btn" id="newTripBtn">建立新車次</button>
      </div>
      <div class="small" style="margin-top:6px;">批次會帶入 created_by / updated_by = DRV:&lt;DriverID&gt;。</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="flex between">
        <div>
          <h3>來源與品項</h3>
          <p class="small">一個來源可包含多個品項，儲存後寫入選定車次。</p>
        </div>
        <button class="btn" id="addSourceBtn">新增來源</button>
      </div>
      <div id="sourceList" class="list" style="margin-top:10px;"></div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Trip 摘要</h3>
      <div id="tripSummary"></div>
    </div>
  </div>

  <script>
    const driverIdInput = document.getElementById('driverId');
    const tripSelector = document.getElementById('tripSelector');
    const sourceList = document.getElementById('sourceList');
    const tripSummary = document.getElementById('tripSummary');
    const newTripBtn = document.getElementById('newTripBtn');
    let currentTripId = '';
    let sources = [];
    let tripCreated = false;

    function requireDriverId() {
      const id = driverIdInput.value.trim();
      if (!id) {
        alert('需填 Driver ID 才能作業。');
        return null;
      }
      return id;
    }

    function buildTripOptionLabel(trip) {
      const parts = [];
      Object.entries(trip.statuses || {}).forEach(([k, v]) => parts.push(`${k}:${v}`));
      return `${trip.trip_id} (${parts.join(', ') || '0'})`;
    }

    function refreshTrips() {
      const trips = MockDB.getTrips();
      tripSelector.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = currentTripId ? '(請選擇)' : '請先建立車次';
      tripSelector.appendChild(placeholder);
      trips.forEach((t) => {
        const opt = document.createElement('option');
        opt.value = t.trip_id;
        opt.textContent = buildTripOptionLabel(t);
        if (t.trip_id === currentTripId) opt.selected = true;
        tripSelector.appendChild(opt);
      });
    }

    function createTrip() {
      if (tripCreated) {
        tapmcUtils.toast('車次已建立，無法再建立。', 'warn');
        return;
      }
      const id = requireDriverId();
      if (!id) return;
      currentTripId = `${tapmcUtils.timestamp14()}-${id}`;
      tripCreated = true;
      newTripBtn.disabled = true;
      newTripBtn.textContent = '已建立';
      tapmcUtils.toast(`已建立車次 ${currentTripId}`);
      refreshTrips();
      renderSummary();
    }

    function addSourceCard() {
      sources.push({
        id: `src-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`,
        name: '',
        producer: '',
        items: []
      });
      renderSources();
    }

    function renderSources() {
      sourceList.innerHTML = '';
      if (!sources.length) {
        sourceList.innerHTML = '<div class="small">請新增來源後輸入品項。</div>';
        return;
      }
      sources.forEach((src) => {
        const card = document.createElement('div');
        card.className = 'card subtle';
        card.innerHTML = `
          <div class="flex between" style="gap:16px;">
            <div style="flex:1;">
              <label>來源名稱</label>
              <div class="input-row" style="gap:10px;">
                <input data-src="${src.id}" data-field="name" type="text" value="${src.name}" placeholder="例：BigTreeFarm">
                <input data-src="${src.id}" data-field="producer" type="text" value="${src.producer}" placeholder="供應人">
              </div>
            </div>
            <div class="input-row">
              <div class="tag">品項數：${src.items.length}</div>
              <button class="btn danger" data-remove-src="${src.id}">刪除來源</button>
            </div>
          </div>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label>品項</label>
              <select data-src="${src.id}" class="field-product">
                <option value="">請選擇</option>
                ${Object.entries(PRODUCT_SCHEMAS).map(([id, meta]) => `<option value="${id}">${meta.name}</option>`).join('')}
              </select>
            </div>
            <div>
              <label>箱數</label>
              <input data-src="${src.id}" class="field-boxes" type="number" min="1" value="5">
            </div>
            <div>
              <label>重量/數量</label>
              <input data-src="${src.id}" class="field-qty" type="number" min="1" value="5">
            </div>
          </div>
          <label style="margin-top:8px; display:block;">備註</label>
          <textarea data-src="${src.id}" class="field-note" placeholder="可填寫產地、等級等備註"></textarea>
          <div class="input-row" style="margin-top:10px;">
            <button class="btn secondary" data-add-item="${src.id}">新增品項</button>
            <button class="btn" data-submit-src="${src.id}">儲存此來源</button>
          </div>
          <div class="table-scroll" style="margin-top:10px;">
            <table>
              <thead><tr><th>品項</th><th>箱數</th><th>數量</th><th>備註</th><th></th></tr></thead>
              <tbody>
                ${src.items.map((it, idx) => `<tr><td>${it.product_name || it.product_id}</td><td>${it.boxes}</td><td>${it.quantity}</td><td>${it.note || ''}</td><td><button class="btn secondary" data-remove-item="${src.id}" data-index="${idx}">移除</button></td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        `;
        card.querySelectorAll('input[data-field]').forEach((input) => {
          input.addEventListener('input', (e) => {
            const sid = e.target.dataset.src;
            const field = e.target.dataset.field;
            const s = sources.find((x) => x.id === sid);
            if (s && field) s[field] = e.target.value;
          });
        });
        card.querySelector('[data-remove-src]').addEventListener('click', () => {
          sources = sources.filter((s) => s.id !== src.id);
          renderSources();
        });
        card.querySelector('[data-add-item]').addEventListener('click', () => {
          const product = card.querySelector('.field-product').value;
          const productName = PRODUCT_SCHEMAS[product]?.name || '';
          const boxes = Number(card.querySelector('.field-boxes').value);
          const quantity = Number(card.querySelector('.field-qty').value);
          const note = card.querySelector('.field-note').value.trim();
          if (!product || boxes <= 0) {
            alert('品項與箱數為必填。');
            return;
          }
          const s = sources.find((x) => x.id === src.id);
          if (!s.items) s.items = [];
          s.items.push({ product_id: product, product_name: productName, boxes, quantity, note, source: s.name, producer: s.producer });
          renderSources();
        });
        card.querySelectorAll('[data-remove-item]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const s = sources.find((x) => x.id === btn.dataset.removeItem);
            const idx = Number(btn.dataset.index);
            s.items.splice(idx, 1);
            renderSources();
          });
        });
        card.querySelector('[data-submit-src]').addEventListener('click', () => submitSource(src.id));
        sourceList.appendChild(card);
      });
    }

    function ensureTripSelected() {
      if (!currentTripId && !tripSelector.value) {
        alert('請先建立或選擇車次。');
        return false;
      }
      currentTripId = currentTripId || tripSelector.value;
      return true;
    }

    function submitSource(sourceId) {
      const id = requireDriverId();
      if (!id) return;
      if (!ensureTripSelected()) return;
      const src = sources.find((s) => s.id === sourceId);
      if (!src) return;
      if (!src.name) {
        alert('請填來源名稱。');
        return;
      }
      if (!src.items.length) {
        alert('此來源沒有品項。');
        return;
      }
      if (!confirm(`將來源「${src.name}」的 ${src.items.length} 筆品項寫入車次？`)) return;
      src.items.forEach((item) => {
        const batchId = genUniqueBatchId('DRV');
        const row = MockDB.appendCsvRow({
          trip_id: currentTripId,
          batch_id: batchId,
          product_id: item.product_id,
          item: item.product_name || '',
          source: src.name,
          producer: src.producer,
          boxes: item.boxes,
          quantity: item.quantity,
          price: 0,
          currency: 'TWD',
          quality_data: {},
          ai_suggestions: null,
          final_grade: '',
          start_price: '',
          status: 'created',
          note: item.note,
          created_by: `DRV:${id}`,
          updated_by: `DRV:${id}`
        });
        MockDB.appendLog({ role: 'DRV', actor_id: id, action: 'create_batch', row_id: row.row_id, ts: row.created_at });
      });
      src.items = [];
      tapmcUtils.toast(`已儲存來源「${src.name}」的批次`);
      renderSources();
      refreshTrips();
      renderSummary();
    }

    function genUniqueBatchId(role) {
      let suffix = 0;
      let id = '';
      const rows = MockDB.getRows();
      do {
        id = tapmcUtils.genBatchId(role, suffix);
        suffix += 1;
      } while (rows.some((r) => r.batch_id === id));
      return id;
    }

    function renderSummary() {
      const tripId = currentTripId || tripSelector.value;
      if (!tripId) {
        tripSummary.innerHTML = '<div class="small">建立車次後會顯示批次。</div>';
        return;
      }
      const rows = MockDB.getRows({ trip_id: tripId });
      if (!rows.length) {
        tripSummary.innerHTML = '<div class="small">尚無批次。</div>';
        return;
      }
      const html = `
        <div class="table-scroll">
          <table>
            <thead><tr><th>批次</th><th>品項</th><th>來源</th><th>箱數</th><th>狀態</th><th>備註</th><th></th></tr></thead>
            <tbody>
              ${rows.map((r) => `
                <tr>
                  <td>${r.batch_id}</td>
                  <td>${r.item || ''}</td>
                  <td>${r.source || ''}</td>
                  <td>${r.boxes}</td>
                  <td>${tapmcUtils.statusBadge(r.status)}</td>
                  <td>${r.note || ''}</td>
                  <td>
                    <button class="btn secondary" data-edit="${r.row_id}">編輯</button>
                    <button class="btn danger" data-del="${r.row_id}">刪除</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      tripSummary.innerHTML = html;
      tripSummary.querySelectorAll('[data-edit]').forEach((btn) => {
        btn.addEventListener('click', () => editRow(btn.dataset.edit));
      });
      tripSummary.querySelectorAll('[data-del]').forEach((btn) => {
        btn.addEventListener('click', () => deleteRow(btn.dataset.del));
      });
    }

    function editRow(rowId) {
      const id = requireDriverId();
      if (!id) return;
      const row = MockDB.getRows().find((r) => r.row_id === rowId);
      if (!row) return;
      const boxes = prompt('箱數', row.boxes);
      if (boxes === null) return;
      const quantity = prompt('數量', row.quantity);
      if (quantity === null) return;
      const note = prompt('備註', row.note || '');
      const updated = MockDB.updateRow(rowId, { boxes: Number(boxes), quantity: Number(quantity), note, updated_by: `DRV:${id}` });
      MockDB.appendLog({ role: 'DRV', actor_id: id, action: 'update_batch', row_id: rowId, ts: updated.updated_at });
      tapmcUtils.toast('批次已更新');
      renderSummary();
    }

    function deleteRow(rowId) {
      const id = requireDriverId();
      if (!id) return;
      if (!confirm('確定刪除此批次？')) return;
      MockDB.deleteRow(rowId);
      MockDB.appendLog({ role: 'DRV', actor_id: id, action: 'delete_batch', row_id: rowId });
      tapmcUtils.toast('批次已刪除', 'warn');
      refreshTrips();
      renderSummary();
    }

    tripSelector.addEventListener('change', () => {
      currentTripId = tripSelector.value;
      renderSummary();
    });

    newTripBtn.addEventListener('click', createTrip);
    document.getElementById('addSourceBtn').addEventListener('click', addSourceCard);

    driverIdInput.value = MockDB.getDefaultId() || '';
    refreshTrips();
    renderSources();
    renderSummary();
  </script>
</body>
</html>
