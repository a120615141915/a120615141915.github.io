<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Auction | TAPMC</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="common.js"></script>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div>
        <h1>拍賣大螢幕</h1>
        <div class="small">輪播已分級批次，快速標記售出或退貨。</div>
      </div>
      <a class="pill" href="index.html">⬅ 回到首頁</a>
    </div>

    <div class="card">
      <div class="input-row">
        <div style="flex:1;">
          <label for="auctionId">Auction ID（操作員）</label>
          <input id="auctionId" type="text" placeholder="auc01">
        </div>
        <div class="chip-row">
          <span class="chip"><span class="kbd">Space</span> 下一筆 · <span class="kbd">P</span> 上一筆</span>
          <span class="chip"><span class="kbd">S</span> 售出 · <span class="kbd">R</span> 退貨</span>
        </div>
      </div>
    </div>

    <div class="card carousel" style="margin-top:16px;">
      <div class="img-placeholder" id="carouselVisual">目前沒有 graded 批次</div>
      <div>
        <div class="flex between">
          <h3 id="auctionTitle">—</h3>
          <div id="auctionStatus" class="tag"></div>
        </div>
        <div id="auctionMeta" class="list" style="margin:10px 0;"></div>
        <div class="input-row">
          <button class="btn secondary" id="prevBtn">上一筆</button>
          <button class="btn secondary" id="nextBtn">下一筆</button>
          <button class="btn" id="soldBtn">標記售出</button>
          <button class="btn danger" id="returnBtn">標記退貨</button>
        </div>
        <div class="progress" style="margin-top:10px;"><div class="bar" id="progressBar" style="width:0%;"></div></div>
      </div>
    </div>
  </div>

  <script>
    const auctionIdInput = document.getElementById('auctionId');
    const title = document.getElementById('auctionTitle');
    const statusTag = document.getElementById('auctionStatus');
    const meta = document.getElementById('auctionMeta');
    const visual = document.getElementById('carouselVisual');
    const progressBar = document.getElementById('progressBar');
    let items = [];
    let idx = 0;

    function loadItems() {
      items = MockDB.getRows({ status: 'graded' });
      idx = Math.min(idx, items.length - 1);
      render();
    }

    function render() {
      if (!items.length) {
        visual.textContent = '目前沒有 graded 批次';
        title.textContent = '—';
        statusTag.textContent = '';
        meta.innerHTML = '';
        progressBar.style.width = '0%';
        return;
      }
      const row = items[idx];
      visual.textContent = row.batch_id;
      title.textContent = `${row.item || ''} (${row.batch_id})`;
      statusTag.innerHTML = tapmcUtils.statusBadge(row.status);
      meta.innerHTML = `
        <div class="chip">來源：${row.source}</div>
        <div class="chip">等級：${row.final_grade || '—'}</div>
        <div class="chip">起標價：${row.start_price || '—'} ${row.currency || ''}</div>
        <div class="chip">箱數：${row.boxes}</div>
      `;
      progressBar.style.width = `${((idx + 1) / items.length) * 100}%`;
    }

    function requireAuctionId() {
      const id = auctionIdInput.value.trim();
      if (!id) {
        alert('狀態變更需填 Auction ID。');
        return null;
      }
      return id;
    }

    function mark(status) {
      const aucId = requireAuctionId();
      if (!aucId) return;
      const row = items[idx];
      const updated = MockDB.updateRow(row.row_id, { status, updated_by: `AUC:${aucId}` });
      MockDB.appendLog({ role: 'AUC', actor_id: aucId, action: status === 'sold' ? 'mark_sold' : 'mark_return', row_id: row.row_id, ts: updated.updated_at });
      tapmcUtils.toast(`已標記 ${status}`);
      loadItems();
    }

    function next() {
      if (!items.length) return;
      idx = (idx + 1) % items.length;
      render();
    }
    function prev() {
      if (!items.length) return;
      idx = (idx - 1 + items.length) % items.length;
      render();
    }

    document.getElementById('nextBtn').addEventListener('click', next);
    document.getElementById('prevBtn').addEventListener('click', prev);
    document.getElementById('soldBtn').addEventListener('click', () => mark('sold'));
    document.getElementById('returnBtn').addEventListener('click', () => mark('returned'));

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); next(); }
      if (e.key.toLowerCase() === 'p') { prev(); }
      if (e.key.toLowerCase() === 's') { mark('sold'); }
      if (e.key.toLowerCase() === 'r') { mark('returned'); }
    });

    auctionIdInput.value = MockDB.getDefaultId() || '';
    loadItems();
  </script>
</body>
</html>
